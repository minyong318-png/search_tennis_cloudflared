<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Supabase JS (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¾ ìš©ì¸ í…Œë‹ˆìŠ¤ ì˜ˆì•½</title>

  <style>
  :root{
    --bg:#f5f7fb;
    --card:#ffffff;
    --text:#0f172a;
    --sub:#64748b;
    --primary:#4f46e5;
    --border:#e5e7eb;
    --radius:18px;
  }

  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    background:linear-gradient(180deg,#eef2ff,#f8fafc);
    color:var(--text);
  }

  .container{
    max-width:900px;
    margin:0 auto;
    padding:20px 16px 160px;
  }

  .header h1{ margin:0; font-size:22px; font-weight:800; }
  .header .updated{ margin-top:6px; font-size:13px; color:var(--sub); }

  .card{
    background:var(--card);
    border-radius:var(--radius);
    padding:18px;
    box-shadow:0 10px 28px rgba(0,0,0,.08);
    margin-top:16px;
  }

  .card h3{ margin:0 0 14px; font-size:16px; font-weight:700; }

  .select, .date-box{
    display:flex;
    align-items:center;
    gap:10px;
    padding:14px;
    border-radius:14px;
    border:1px solid var(--border);
    background:#fff;
    font-size:14px;
  }

  .select select{
    border:none;
    outline:none;
    font-size:14px;
    width:100%;
    background:none;
  }

  .date-box{ cursor:pointer; }
  .date-box span{ color:var(--sub); font-size:14px; }
  .date-box input{ position:absolute; opacity:0; pointer-events:none; }

  .filter-stack, .alarm-stack{
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  button{
    margin-top:6px;
    padding:14px;
    border-radius:14px;
    border:none;
    background:var(--primary);
    color:#fff;
    font-weight:700;
    font-size:15px;
    cursor:pointer;
  }
  button:disabled{ opacity:.6; cursor:not-allowed; }

  .court-card{ margin-bottom:22px; }
  .court-title{ font-weight:700; }
  .court-loc{ font-size:13px; color:var(--sub); margin-bottom:6px; }

  .date-box-view{
    background:#f8fafc;
    border-radius:14px;
    padding:12px;
    margin-top:10px;
  }
  .date-title{ font-weight:600; font-size:14px; margin-bottom:8px; }
  .slots{ display:flex; flex-wrap:wrap; gap:8px; }
  .slot{
    padding:8px 12px;
    border-radius:12px;
    border:1px solid var(--border);
    font-size:13px;
    background:#fff;
    text-decoration:none;
    color:inherit;
  }
  </style>
</head>

<body>
<div id="pullIndicator"
  style="
    position: fixed;
    top: -50px;
    left: 0;
    right: 0;
    height: 50px;
    text-align: center;
    line-height: 50px;
    background: #f5f5f5;
    color: #555;
    font-size: 14px;
    transition: top 0.2s;
    z-index: 9999;
  ">
  ğŸ”„ ì•„ë˜ë¡œ ë‹¹ê²¨ ìƒˆë¡œê³ ì¹¨
</div>

<div class="container">

  <div class="header">
    <h1>ğŸ¾ ìš©ì¸ í…Œë‹ˆìŠ¤ ì˜ˆì•½</h1>
    <div class="updated" id="updatedAt">ì—…ë°ì´íŠ¸ í™•ì¸ ì¤‘â€¦</div>

    <div class="updated">
      <button id="noticeBtn"
        style="font-size:12px;background:none;border:none;color:#666;padding:4px;cursor:pointer;">
        â“˜ ì—…ë°ì´íŠ¸ ë°©ì‹ ë° ì•ŒëŒ ì„¤ì • ì•ˆë‚´
      </button>
    </div>
  </div>

  <!-- í•„í„° -->
  <div class="card">
    <h3>í•„í„°</h3>
    <div class="filter-stack">
      <div class="select">
        ğŸ˜ï¸
        <select id="filterGu">
          <option value="">êµ¬ ì „ì²´</option>
          <option>ì²˜ì¸êµ¬</option>
          <option>ê¸°í¥êµ¬</option>
          <option>ìˆ˜ì§€êµ¬</option>
        </select>
      </div>

      <div class="select">
        ğŸ¾
        <select id="filterCourt">
          <option value="">ì½”íŠ¸ ì „ì²´</option>
        </select>
      </div>

      <label class="date-box" onclick="filterDate.click()">
        ğŸ“… <span id="filterDateLabel">ë‚ ì§œ ì„ íƒ</span>
        <input type="date" id="filterDate">
      </label>
    </div>
  </div>

  <!-- ì•ŒëŒ -->
  <div class="card">
    <h3>ğŸ”” ì•ŒëŒ ë“±ë¡</h3>
    <div class="alarm-stack">
      <div class="select">
        ğŸ¾
        <select id="alarmCourt">
          <option value="">ì½”íŠ¸ ì„ íƒ</option>
        </select>
      </div>

      <label class="date-box" onclick="alarmDate.click()">
        ğŸ“… <span id="alarmDateLabel">ë‚ ì§œ ì„ íƒ</span>
        <input type="date" id="alarmDate">
      </label>

      <button id="alarmBtn">ì•ŒëŒ ë“±ë¡</button>
    </div>

    <div id="alarmList" style="margin-top:12px;font-size:13px;color:var(--sub)">
      ë“±ë¡ëœ ì•ŒëŒì´ ì—†ìŠµë‹ˆë‹¤.
    </div>
  </div>

  <!-- ë°ì´í„° -->
  <div class="card">
    <h3>ì˜ˆì•½ ê°€ëŠ¥ í˜„í™©</h3>
    <div id="courts">â³ ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦</div>
  </div>
</div>

<!-- ì•ˆë‚´ ëª¨ë‹¬ -->
<div id="noticeModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:10000;">
  <div style="background:#fff;max-width:340px;margin:10vh auto;padding:16px;border-radius:10px;max-height:70vh;overflow-y:auto;-webkit-overflow-scrolling:touch;">
    <h3 style="margin-top:0;">ğŸ”„ ì—…ë°ì´íŠ¸ ë°©ì‹ ì•ˆë‚´</h3>
    <p style="font-size:13px;line-height:1.6;">
      ì´ í˜ì´ì§€ì˜ ì˜ˆì•½ ì •ë³´ëŠ” <b>ì¼ë¶€ ì‹œì„¤Â·ë‚ ì§œëŠ” ìµœì‹  ì •ë³´ê°€ ì•„ë‹ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</b><br><br>
      <b>âœ” ë°ì´í„° ìˆ˜ì§‘ ë°©ì‹</b><br>
      â€¢ ìš©ì¸ì‹œ ê³µê³µì˜ˆì•½ ì‹œìŠ¤í…œì„ ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸í•˜ì—¬ ë°ì´í„°ë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.<br>
      â€¢ ì„œë²„ ë¶€í•˜ ë° ì•ˆì •ì„±ì„ ìœ„í•´ <b>ì‹œì„¤ê³¼ ë‚ ì§œë¥¼ ë‚˜ëˆ„ì–´ ìˆœì°¨ì ìœ¼ë¡œ ì¡°íšŒ</b>í•©ë‹ˆë‹¤.<br><br>
      <b>âœ” ì—…ë°ì´íŠ¸ ì£¼ê¸°</b><br>
      â€¢ í˜„ì¬ ì‹œì  3ì¼ ì´í›„ì˜ ë°ì´í„°ëŠ” í•˜ë£¨ì— í•œë²ˆ ê°±ì‹ ë©ë‹ˆë‹¤.(00ì‹œ~)<br>
      â€¢ 3ì¼ ì´ë‚´ì˜ ë°ì´í„°ëŠ” 1ë¶„ë§ˆë‹¤ ì‹œì„¤ì„ ë‚˜ëˆ„ì–´ ê°±ì‹ í•©ë‹ˆë‹¤.<br><br>
      <b>âœ” í‘œì‹œ ì‹œê°„ ì•ˆë‚´</b><br>
      â€¢ ìƒë‹¨ì˜ â€œì—…ë°ì´íŠ¸â€ ì‹œê°„ì€ <b>ê°€ì¥ ìµœê·¼ì— ë°ì´í„°ê°€ ê°±ì‹ ëœ ì‹œì </b>ì…ë‹ˆë‹¤.<br>
      â€¢ íŠ¹ì • ì‹œì„¤Â·ë‚ ì§œì˜ ìµœì‹  ê°±ì‹  ì‹œì ì€ ë³´ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br><br>
      <b>âœ” ì•ŒëŒ ê¸°ëŠ¥</b><br>
      â€¢ ì‚¬ìš©ìê°€ ë“±ë¡í•œ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” <b>ìƒˆë¡œìš´ ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„</b>ì´ ë°œê²¬ë˜ë©´ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤.
    </p>

    <h3 style="margin-top:0;">ğŸ”” ì•ŒëŒ ë“±ë¡ ìœ ì˜ì‚¬í•­</h3>
    <p style="font-size:13px;line-height:1.6;">
      â€¢ ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¸°ëŠ¥ì´ í™œì„±í™”ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.<br>
      â€¢ iOSëŠ” â€œë¸Œë¼ìš°ì € â†’ í™ˆ í™”ë©´ì— ì¶”ê°€â€ í›„ ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
    </p>

    <div style="text-align:right;margin-top:12px;">
      <button id="closeNoticeBtn">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<script>
/** =========================================================
 *  Supabase ì„¤ì • (ë„ˆê°€ ì¤€ ê°’)
 * ========================================================= */
const SUPABASE_URL = "https://fqrvdwfyemdpalvtvccl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZxcnZkd2Z5ZW1kcGFsdnR2Y2NsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNDk5MDYsImV4cCI6MjA4MzgyNTkwNn0.qHPjTARomfJ6fbz7vQy--C6RFclVXLbM8mxQ-ov0wp0";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/** VAPID PUBLIC KEY (ê¸°ì¡´ ê°’ ìœ ì§€) */
const VAPID_PUBLIC_KEY = "BC1eSbg-J7HgWPAd_LJUvCH_fggJsdlvHLEeQUzwVzRcLHv27BiGpe1RlU-bUgduNWNRa15JcEayDFJzNRo07fM";

let DATA = {};
let COURT_GROUPS = {};

/** =========================================================
 *  Utils
 * ========================================================= */
function urlBase64ToUint8Array(base64) {
  const padding = "=".repeat((4 - base64.length % 4) % 4);
  const b64 = (base64 + padding).replace(/-/g, "+").replace(/_/g, "/");
  return Uint8Array.from(atob(b64), c => c.charCodeAt(0));
}

async function sha256Hex(str) {
  const buf = new TextEncoder().encode(str);
  const digest = await crypto.subtle.digest("SHA-256", buf);
  return [...new Uint8Array(digest)].map(b => b.toString(16).padStart(2, "0")).join("");
}

function toYYYYMMDD(dateStr) {
  return (dateStr || "").replaceAll("-", "");
}

function yyyymmddToPretty(yyyymmdd) {
  if (!yyyymmdd) return "";
  if (yyyymmdd.includes("-")) return yyyymmdd;
  if (yyyymmdd.length !== 8) return yyyymmdd;
  return `${yyyymmdd.slice(0,4)}-${yyyymmdd.slice(4,6)}-${yyyymmdd.slice(6,8)}`;
}

function getCourtGroup(title){
  return (title || "")
    .replace(/\[.*?\]/g, "")
    .split("í…Œë‹ˆìŠ¤ì¥")[0]
    .trim();
}

function getWeekday(yyyymmdd){
  const d=new Date(
    yyyymmdd.slice(0,4),
    yyyymmdd.slice(4,6)-1,
    yyyymmdd.slice(6,8)
  );
  return ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][d.getDay()];
}

function makeReserveLink(resveId){
  const base =
    "https://publicsports.yongin.go.kr/publicsports/sports/selectFcltyRceptResveViewU.do";
  return `${base}?key=4236&resveId=${resveId}&pageUnit=8&pageIndex=1&checkSearchMonthNow=false`;
}

function renderUpdatedTime(isoUtc) {
  if (!isoUtc) return;
  const d = new Date(isoUtc);
  const kstMs = d.getTime() + 9 * 60 * 60 * 1000;
  const kst = new Date(kstMs);
  const hh = String(kst.getHours()).padStart(2, "0");
  const mm = String(kst.getMinutes()).padStart(2, "0");
  document.getElementById("updatedAt").textContent = `ì—…ë°ì´íŠ¸: ${hh}:${mm}`;
}

/** =========================================================
 *  âœ… DATA: Supabase RPCë¡œ ë¡œë“œ
 *  - public.get_public_data(p_days_ahead int) í•„ìš”
 * ========================================================= */
async function loadData() {
  try {
    const { data, error } = await supabase.rpc("get_public_data", { p_days_ahead: 45 });
    if (error) throw new Error(error.message || "RPC error");
    if (!data) throw new Error("RPC returned null");

    DATA = data;
    renderUpdatedTime(data.updated_at);
    buildCourtGroups();
    renderCourts();
  } catch (e) {
    console.error("[loadData error]", e);
    document.getElementById("courts").innerHTML =
      "â³ Supabaseì—ì„œ ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>" +
      "<div style='margin-top:8px;font-size:13px;color:#666'>ì½˜ì†” ì—ëŸ¬ë¥¼ í™•ì¸í•˜ì„¸ìš”: " +
      (e.message || e) + "</div>";
  }
}

function buildCourtGroups(){
  COURT_GROUPS = {};

  if (!DATA || !DATA.facilities || typeof DATA.facilities !== "object") return;

  Object.values(DATA.facilities).forEach(f => {
    if (!f || !f.title) return;
    const g = getCourtGroup(f.title);
    COURT_GROUPS[g] = true;
  });

  filterCourt.innerHTML = '<option value="">ì½”íŠ¸ ì „ì²´</option>';
  alarmCourt.innerHTML = '<option value="">ì½”íŠ¸ ì„ íƒ</option>';

  Object.keys(COURT_GROUPS)
    .sort((a, b) => a.localeCompare(b, "ko"))
    .forEach(g => {
      filterCourt.innerHTML += `<option>${g}</option>`;
      alarmCourt.innerHTML += `<option>${g}</option>`;
    });
}

function renderCourts() {
  const courtsEl = document.getElementById("courts");

  if (!DATA || typeof DATA !== "object" || !DATA.facilities || !DATA.availability) {
    courtsEl.textContent = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦";
    return;
  }

  courtsEl.innerHTML = "";

  const gu = filterGu.value;
  const group = filterCourt.value;
  const date = filterDate.value ? filterDate.value.replaceAll("-", "") : "";

  let renderedCount = 0;

  for (const cid in DATA.facilities) {
    const fac = DATA.facilities[cid];
    if (!fac || !fac.title) continue;

    const courtGroup = getCourtGroup(fac.title);

    if (gu && !(fac.location || "").includes(gu)) continue;
    if (group && courtGroup !== group) continue;

    const days = DATA.availability[cid];
    if (!days || typeof days !== "object") continue;

    let hasAnySlot = false;
    let html = `
      <div class="court-card">
        <div class="court-title">${fac.title}</div>
        <div class="court-loc">${fac.location || ""}</div>
    `;

    for (const d in days) {
      if (date && d !== date) continue;
      const slots = days[d];
      if (!Array.isArray(slots) || slots.length === 0) continue;

      hasAnySlot = true;

      html += `
        <div class="date-box-view">
          <div class="date-title">
            ${d.slice(4, 6)}.${d.slice(6, 8)} (${getWeekday(d)})
          </div>
          <div class="slots">
      `;

      for (const s of slots) {
        if (!s || !s.timeContent) continue;

        const reserveId = s.resveId || cid;

        html += `
          <a class="slot"
             href="${makeReserveLink(reserveId)}"
             target="_blank"
             rel="noopener noreferrer">
            ${s.timeContent}
          </a>
        `;
      }

      html += `
          </div>
        </div>
      `;
    }

    html += `</div>`;

    if (hasAnySlot) {
      courtsEl.insertAdjacentHTML("beforeend", html);
      renderedCount++;
    }
  }

  if (renderedCount === 0) {
    courtsEl.textContent = "ì¡°ê±´ì— ë§ëŠ” ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.";
  }
}

/** =========================================================
 *  Pull-to-refresh
 * ========================================================= */
let pullStartY = null;
let isRefreshing = false;
const pullIndicator = document.getElementById("pullIndicator");
const PULL_THRESHOLD = 70;

window.addEventListener("touchstart", e => {
  if (window.scrollY === 0 && !isRefreshing) pullStartY = e.touches[0].clientY;
}, { passive: true });

window.addEventListener("touchmove", e => {
  if (pullStartY === null || isRefreshing) return;
  const currentY = e.touches[0].clientY;
  const diff = currentY - pullStartY;

  if (diff > 0) {
    e.preventDefault();
    const offset = Math.min(diff, 80);
    pullIndicator.style.top = (-50 + offset) + "px";
    pullIndicator.textContent = "ğŸ”„ Refresh";
  }
}, { passive: false });

window.addEventListener("touchend", async () => {
  if (pullStartY === null || isRefreshing) return;

  const indicatorTop = parseInt(pullIndicator.style.top || "-50", 10);
  pullIndicator.style.top = "-50px";

  if (indicatorTop > 20) {
    isRefreshing = true;
    pullIndicator.textContent = "â³ Refreshing...";
    pullIndicator.style.top = "0px";

    try {
      await loadData();
      await loadMyAlarms();
    } catch (e) {
      alert("ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: " + (e.message || e));
    }

    pullIndicator.style.top = "-50px";
    isRefreshing = false;
  }
  pullStartY = null;
});

/** =========================================================
 *  Push subscribe + push_subscriptions upsert
 *  - subscription_id = sha256(endpoint)
 * ========================================================= */
function checkPushSupport() {
  if (!("serviceWorker" in navigator)) throw new Error("serviceWorker not supported");
  if (!("PushManager" in window)) throw new Error("PushManager not supported");
}

async function requestNotificationPermission() {
  const permission = await Notification.requestPermission();
  if (permission !== "granted") throw new Error("notification permission denied");
  return permission;
}

async function waitForServiceWorker() {
  const readyPromise = navigator.serviceWorker.ready;
  const timeoutPromise = new Promise((_, reject) =>
    setTimeout(() => reject(new Error("serviceWorker.ready timeout")), 3000)
  );

  try {
    return await Promise.race([readyPromise, timeoutPromise]);
  } catch (_) {
    const fallbackReg = await navigator.serviceWorker.getRegistration();
    if (!fallbackReg) throw new Error("No service worker registration");
    return fallbackReg;
  }
}

async function subscribePush(reg) {
  const existing = await reg.pushManager.getSubscription();
  if (existing) return existing;

  return await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
  });
}

async function saveSubscriptionToSupabase(sub) {
  const j = sub.toJSON();
  const endpoint = j.endpoint;
  const p256dh = j.keys?.p256dh;
  const auth = j.keys?.auth;

  if (!endpoint || !p256dh || !auth) throw new Error("push subscription keys missing");

  const subscription_id = await sha256Hex(endpoint);

  const { error } = await supabase
    .from("push_subscriptions")
    .upsert({ id: subscription_id, endpoint, p256dh, auth });

  if (error) throw new Error("push_subscriptions upsert failed: " + error.message);

  return subscription_id;
}

async function enablePushIfNeeded({ silent = false } = {}) {
  try {
    const existing = localStorage.getItem("subscription_id");
    if (existing) return existing;

    checkPushSupport();
    await requestNotificationPermission();

    const reg = await waitForServiceWorker();
    const sub = await subscribePush(reg);
    const subscriptionId = await saveSubscriptionToSupabase(sub);

    localStorage.setItem("subscription_id", subscriptionId);

    if (!silent) alert("ğŸ‰ ì•Œë¦¼ ì„¤ì • ì™„ë£Œ");
    return subscriptionId;
  } catch (e) {
    console.error("enablePushIfNeeded error:", e);
    if (!silent) alert("âŒ ERROR: " + (e.message || e));
    throw e;
  }
}

/** =========================================================
 *  alarms ì €ì¥/ì¡°íšŒ/ì‚­ì œ (Supabase)
 * ========================================================= */
async function addAlarm(subscriptionId, courtGroup, yyyymmdd) {
  const { error } = await supabase
    .from("alarms")
    .insert({ subscription_id: subscriptionId, court_group: courtGroup, date: yyyymmdd });

  if (error) {
    const msg = (error.message || "").toLowerCase();
    if (msg.includes("duplicate") || msg.includes("unique")) return { status: "duplicate" };
    throw new Error(error.message || "insert failed");
  }
  return { status: "added" };
}

async function loadMyAlarms() {
  let subscriptionId = localStorage.getItem("subscription_id");
  const alarmListEl = document.getElementById("alarmList");

  if (!subscriptionId) {
    try {
      subscriptionId = await enablePushIfNeeded({ silent: true });
    } catch {
      alarmListEl.innerHTML = "<li>ë“±ë¡ëœ ì•ŒëŒì´ ì—†ìŠµë‹ˆë‹¤.</li>";
      return;
    }
  }

  const { data: alarms, error } = await supabase
    .from("alarms")
    .select("id, date, court_group")
    .eq("subscription_id", subscriptionId)
    .order("date", { ascending: true });

  if (error) {
    alarmListEl.innerHTML = "<li>ì•ŒëŒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>";
    return;
  }

  if (!alarms || alarms.length === 0) {
    alarmListEl.innerHTML = "<li>ë“±ë¡ëœ ì•ŒëŒì´ ì—†ìŠµë‹ˆë‹¤.</li>";
    return;
  }

  alarmListEl.innerHTML = "";

  for (const a of alarms) {
    const li = document.createElement("li");
    li.style.display = "flex";
    li.style.justifyContent = "space-between";
    li.style.alignItems = "center";

    const text = document.createElement("span");
    const ymd = (a.date || "").includes("-") ? a.date.replaceAll("-","") : a.date;
    text.textContent = `${yyyymmddToPretty(ymd)} Â· ${a.court_group}`;

    const delBtn = document.createElement("button");
    delBtn.textContent = "âœ•";
    delBtn.style.fontSize = "12px";
    delBtn.style.padding = "2px 6px";
    delBtn.style.border = "1px solid #ccc";
    delBtn.style.borderRadius = "4px";
    delBtn.style.background = "#fff";
    delBtn.style.color = "#888";
    delBtn.style.marginTop = "0";

    delBtn.onclick = async () => {
      if (!confirm("ì´ ì•ŒëŒì„ ì‚­ì œí• ê¹Œìš”?")) return;
      await deleteAlarmById(a.id);
      await loadMyAlarms();
    };

    li.appendChild(text);
    li.appendChild(delBtn);
    alarmListEl.appendChild(li);
  }
}

async function deleteAlarmById(alarmId) {
  const { error } = await supabase
    .from("alarms")
    .delete()
    .eq("id", alarmId);

  if (error) alert("ì•ŒëŒ ì‚­ì œ ì‹¤íŒ¨: " + error.message);
}

/** =========================================================
 *  events
 * ========================================================= */
filterGu.onchange = renderCourts;
filterCourt.onchange = renderCourts;

filterDate.onchange = () => {
  filterDateLabel.textContent = filterDate.value;
  renderCourts();
};
alarmDate.onchange = () => {
  alarmDateLabel.textContent = alarmDate.value;
};

alarmBtn.onclick = async () => {
  try {
    const subscriptionId = await enablePushIfNeeded();

    if (!alarmCourt.value || !alarmDate.value) {
      alert("ì½”íŠ¸ì™€ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”");
      return;
    }

    const ymd = toYYYYMMDD(alarmDate.value);
    const res = await addAlarm(subscriptionId, alarmCourt.value, ymd);

    if (res.status === "duplicate") alert("ì´ë¯¸ ë“±ë¡ëœ ì•ŒëŒì…ë‹ˆë‹¤.");
    else alert("ì•ŒëŒ ë“±ë¡ ì™„ë£Œ!");

    await loadMyAlarms();
  } catch (e) {
    console.error(e);
    alert("ì•Œë¦¼ì„¤ì •/ì•ŒëŒë“±ë¡ ì‹¤íŒ¨: " + (e.message || e));
  }
};

/** =========================================================
 *  Flatpickr (desktop only)
 * ========================================================= */
function isDesktop() { return window.innerWidth >= 768; }

if (isDesktop()) {
  flatpickr("#filterDate", {
    dateFormat: "Y-m-d",
    onChange: function(_, dateStr) {
      filterDateLabel.textContent = dateStr;
      renderCourts();
    }
  });

  flatpickr("#alarmDate", {
    dateFormat: "Y-m-d",
    onChange: function(_, dateStr) {
      alarmDateLabel.textContent = dateStr;
    }
  });
}

async function init() {
  await loadData();
  await loadMyAlarms();
}

document.addEventListener("DOMContentLoaded", () => {
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/sw.js").catch(err => console.error("SW register failed:", err));
  }
  init();
});

/** modal */
document.getElementById("noticeBtn").onclick = () => {
  document.getElementById("noticeModal").style.display = "block";
};
document.getElementById("closeNoticeBtn").onclick = () => {
  document.getElementById("noticeModal").style.display = "none";
};
document.getElementById("noticeModal").onclick = (e) => {
  if (e.target.id === "noticeModal") e.target.style.display = "none";
};
</script>
</body>
</html>
