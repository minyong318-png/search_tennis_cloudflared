<!DOCTYPE html>
<html lang="ko">
<head>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¾ ìš©ì¸ í…Œë‹ˆìŠ¤ ì˜ˆì•½</title>

<style>
:root{
  --bg:#f5f7fb;
  --card:#ffffff;
  --text:#0f172a;
  --sub:#64748b;
  --primary:#4f46e5;
  --border:#e5e7eb;
  --radius:18px;
}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
  background:linear-gradient(180deg,#eef2ff,#f8fafc);
  color:var(--text);
}

.container{
  max-width:900px;
  margin:0 auto;
  padding:20px 16px 160px;
}

/* ===== í—¤ë” ===== */
.header h1{
  margin:0;
  font-size:22px;
  font-weight:800;
}
.header .updated{
  margin-top:6px;
  font-size:13px;
  color:var(--sub);
}

/* ===== ì¹´ë“œ ===== */
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:18px;
  box-shadow:0 10px 28px rgba(0,0,0,.08);
  margin-top:16px;
}

.card h3{
  margin:0 0 14px;
  font-size:16px;
  font-weight:700;
}

/* ===== ê³µí†µ ì…ë ¥ ===== */
.select, .date-box{
  display:flex;
  align-items:center;
  gap:10px;
  padding:14px;
  border-radius:14px;
  border:1px solid var(--border);
  background:#fff;
  font-size:14px;
}

.select select{
  border:none;
  outline:none;
  font-size:14px;
  width:100%;
  background:none;
}

.date-box{
  cursor:pointer;
}
.date-box span{
  color:var(--sub);
  font-size:14px;
}

/* ìˆ¨ê¹€ date input */
.date-box input{
  position:absolute;
  opacity:0;
  pointer-events:none;
}

/* ===== í•„í„° ===== */
.filter-stack{
  display:flex;
  flex-direction:column;
  gap:10px;
}

/* ===== ì•ŒëŒ ===== */
.alarm-stack{
  display:flex;
  flex-direction:column;
  gap:10px;
}

button{
  margin-top:6px;
  padding:14px;
  border-radius:14px;
  border:none;
  background:var(--primary);
  color:#fff;
  font-weight:700;
  font-size:15px;
}

/* ===== ì˜ˆì•½ ë°ì´í„° ===== */
.court-card{
  margin-bottom:22px;
}
.court-title{
  font-weight:700;
}
.court-loc{
  font-size:13px;
  color:var(--sub);
  margin-bottom:6px;
}
.date-box-view{
  background:#f8fafc;
  border-radius:14px;
  padding:12px;
  margin-top:10px;
}
.date-title{
  font-weight:600;
  font-size:14px;
  margin-bottom:8px;
}
.slots{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.slot{
  padding:8px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  font-size:13px;
  background:#fff;
}
</style>
</head>

<body>
<div id="pullIndicator"
    style="
      position: fixed;
      top: -50px;
      left: 0;
      right: 0;
      height: 50px;
      text-align: center;
      line-height: 50px;
      background: #f5f5f5;
      color: #555;
      font-size: 14px;
      transition: top 0.2s;
      z-index: 9999;
    ">
ğŸ”„ ì•„ë˜ë¡œ ë‹¹ê²¨ ìƒˆë¡œê³ ì¹¨
</div>

<div class="container">

  <div class="header">
    <h1>ğŸ¾ ìš©ì¸ í…Œë‹ˆìŠ¤ ì˜ˆì•½</h1>
    <div class="updated" id="updatedAt">ì—…ë°ì´íŠ¸ í™•ì¸ ì¤‘â€¦</div>
    <!-- ğŸ” ì—…ë°ì´íŠ¸ ì„¤ëª… ë§í¬ -->
    <div class="updated">
      <button id="noticeBtn"
        style="
          font-size:12px;
          background:none;
          border:none;
          color:#666;
          padding:4px;
          cursor:pointer;
        ">
        â“˜ ì—…ë°ì´íŠ¸ ë°©ì‹ ë° ì•ŒëŒ ì„¤ì • ì•ˆë‚´
      </button>
    </div>
  </div>

  <!-- í•„í„° -->
  <div class="card">
    <h3>í•„í„°</h3>
    <div class="filter-stack">
      <div class="select">
        ğŸ˜ï¸
        <select id="filterGu">
          <option value="">êµ¬ ì „ì²´</option>
          <option>ì²˜ì¸êµ¬</option>
          <option>ê¸°í¥êµ¬</option>
          <option>ìˆ˜ì§€êµ¬</option>
        </select>
      </div>

      <div class="select">
        ğŸ¾
        <select id="filterCourt">
          <option value="">ì½”íŠ¸ ì „ì²´</option>
        </select>
      </div>

      <label class="date-box" onclick="filterDate.click()">
        ğŸ“… <span id="filterDateLabel">ë‚ ì§œ ì„ íƒ</span>
        <input type="date" id="filterDate">
      </label>
    </div>
  </div>

  <!-- ì•ŒëŒ -->
  <div class="card">
    <h3>ğŸ”” ì•ŒëŒ ë“±ë¡</h3>
    <div class="alarm-stack">
      <div class="select">
        ğŸ¾
        <select id="alarmCourt">
          <option value="">ì½”íŠ¸ ì„ íƒ</option>
        </select>
      </div>

      <label class="date-box" onclick="alarmDate.click()">
        ğŸ“… <span id="alarmDateLabel">ë‚ ì§œ ì„ íƒ</span>
        <input type="date" id="alarmDate">
      </label>

      <button id="alarmBtn">ì•ŒëŒ ë“±ë¡</button>
    </div>

    <div id="alarmList" style="margin-top:12px;font-size:13px;color:var(--sub)">
      ë“±ë¡ëœ ì•ŒëŒì´ ì—†ìŠµë‹ˆë‹¤.
    </div>
  </div>

  <!-- ë°ì´í„° -->
  <div class="card">
    
    <h3>ì˜ˆì•½ ê°€ëŠ¥ í˜„í™© </h3>
    <div id="courts">
      â³ ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦
    </div>
  </div>
</div>
<div id="noticeModal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  z-index:10000;
">
  <div id="noticeModalContent" style="
    background:#fff;
    max-width:340px;
    margin:10vh auto;
    padding:16px;
    border-radius:10px;

    /* ğŸ”¥ í•µì‹¬ */
    max-height:70vh;
    overflow-y:auto;
    -webkit-overflow-scrolling: touch;
  ">
    
    <h3 style="margin-top:0;">ğŸ”„ ì—…ë°ì´íŠ¸ ë°©ì‹ ì•ˆë‚´</h3>

    <p style="font-size:13px;line-height:1.6;">
    ì´ í˜ì´ì§€ì˜ ì˜ˆì•½ ì •ë³´ëŠ” <b>ì¼ë¶€ ì‹œì„¤Â·ë‚ ì§œëŠ” ìµœì‹  ì •ë³´ê°€ ì•„ë‹ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</b><br><br>

    <b>âœ” ë°ì´í„° ìˆ˜ì§‘ ë°©ì‹</b><br>
    â€¢ ìš©ì¸ì‹œ ê³µê³µì˜ˆì•½ ì‹œìŠ¤í…œì„ ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸í•˜ì—¬ ë°ì´í„°ë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.<br>
    â€¢ ì„œë²„ ë¶€í•˜ ë° ì•ˆì •ì„±ì„ ìœ„í•´ <b>ì‹œì„¤ê³¼ ë‚ ì§œë¥¼ ë‚˜ëˆ„ì–´ ìˆœì°¨ì ìœ¼ë¡œ ì¡°íšŒ</b>í•©ë‹ˆë‹¤.<br><br>

    <b>âœ” ì—…ë°ì´íŠ¸ ì£¼ê¸°</b><br>
    â€¢ í˜„ì¬ ì‹œì  3ì¼ ì´í›„ì˜ ë°ì´í„°ëŠ” í•˜ë£¨ì— í•œë²ˆ ê°±ì‹ ë©ë‹ˆë‹¤.(00ì‹œ~)<br>
    â€¢ 3ì¼ ì´ë‚´ì˜ ë°ì´í„°ëŠ” 1ë¶„ë§ˆë‹¤ ì‹œì„¤ì„ ë‚˜ëˆ„ì–´ ê°±ì‹ í•©ë‹ˆë‹¤..<br><br>

    <b>âœ” í‘œì‹œ ì‹œê°„ ì•ˆë‚´</b><br>
    â€¢ ìƒë‹¨ì˜ â€œì—…ë°ì´íŠ¸â€ ì‹œê°„ì€ <b>ê°€ì¥ ìµœê·¼ì— ë°ì´í„°ê°€ ê°±ì‹ ëœ ì‹œì </b>ì…ë‹ˆë‹¤.<br>
    â€¢ íŠ¹ì • ì‹œì„¤Â·ë‚ ì§œì˜ ìµœì‹  ê°±ì‹  ì‹œì ì€ ë³´ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br><br>
    
    <b>âœ” ì•ŒëŒ ê¸°ëŠ¥</b><br>
    â€¢ ì‚¬ìš©ìê°€ ë“±ë¡í•œ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” <b>ìƒˆë¡œìš´ ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„</b>ì´ ë°œê²¬ë˜ë©´ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤.
    </p>

    <h3 style="margin-top:0;">ğŸ”” ì•ŒëŒ ë“±ë¡ ìœ ì˜ì‚¬í•­</h3>
    â€¢ ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¸°ëŠ¥ì´ í™œì„±í™”ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</p>
    â€¢ ë¸Œë¼ìš°ì € â†’ í™ˆ í™”ë©´ì— ì¶”ê°€ í›„ ì‚¬ìš©</p>

    - (ì•„ì´í° ê¸°ì¤€)ë¸Œë¼ìš°ì € ë‚´ ...ë²„íŠ¼ì„ ëˆŒëŸ¬ ê³µìœ  ë²„íŠ¼ í´ë¦­
    <img src="/static/ios_add_home_1.png"
         style="width:100%;border-radius:6px;">
    
    - ë”ë³´ê¸° í˜¹ì€ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•˜ì—¬ í™ˆ í™”ë©´ì— ì¶”ê°€ í´ë¦­
    <img src="/static/ios_add_home_2.png"
         style="width:100%;margin-top:8px;border-radius:6px;">

    <div style="text-align:right;margin-top:12px;">
      <button id="closeNoticeBtn">ë‹«ê¸°</button>
    </div>
  </div>


    


<script>
const VAPID_PUBLIC_KEY = "BC1eSbg-J7HgWPAd_LJUvCH_fggJsdlvHLEeQUzwVzRcLHv27BiGpe1RlU-bUgduNWNRa15JcEayDFJzNRo07fM";
const API_BASE = "https://yongin-tennis-worker.ccoo2000.workers.dev";

let DATA = {};
let COURT_GROUPS = {};

function urlBase64ToUint8Array(base64) {
  const padding = "=".repeat((4 - base64.length % 4) % 4);
  const b64 = (base64 + padding).replace(/-/g, "+").replace(/_/g, "/");
  return Uint8Array.from(atob(b64), c => c.charCodeAt(0));
}

alarmBtn.onclick = async () => {
  try {
    const existing = localStorage.getItem("subscription_id");
    const perm = Notification.permission;

    // ğŸ”” ì•„ì§ ê¶Œí•œ ìš”ì²­ ì•ˆ í–ˆì„ ë•Œ
    if (perm === "default") {
      await requestNotificationPermissionOnly();
      alert("ì•Œë¦¼ì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤. í•œ ë²ˆ ë” ëˆŒëŸ¬ì£¼ì„¸ìš”.");
      return;
    }

    // âŒ ê±°ë¶€ëœ ìƒíƒœ
    if (perm === "denied") {
      alert("ì•Œë¦¼ì´ ì°¨ë‹¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. iOS ì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”.");
      return;
    }

    // âœ… ì´ë¯¸ í—ˆìš©ëœ ìƒíƒœ â†’ ì—¬ê¸°ì„œë§Œ push êµ¬ë…
    const subId = existing || await subscribePushAfterPermission();

    // ì—¬ê¸°ë¶€í„° ì•ŒëŒ ë“±ë¡
    await fetch(API_BASE + "/api/alarm/add", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        subscription_id: subId,
        court_group: alarmCourt.value,
        date: alarmDate.value
      })
    });

    alert("ì•ŒëŒ ë“±ë¡ ì™„ë£Œ!");

  } catch (e) {
    alert("ì˜¤ë¥˜: " + e.message);
  }
};

async function requestNotificationPermissionOnly() {
  const perm = await Notification.requestPermission();
  if (perm !== "granted") {
    throw new Error("notification permission denied");
  }
  return true;
}

async function subscribePushAfterPermission() {
  // 0) ê¶Œí•œ í™•ì¸ (ì´ë¯¸ í—ˆìš©ëœ ìƒíƒœê°€ ì•„ë‹ˆë©´ ìš”ì²­)
  if (Notification.permission !== "granted") {
    const perm = await Notification.requestPermission();
    if (perm !== "granted") throw new Error("Notification permission denied");
  }

  const reg = await navigator.serviceWorker.ready;

  // 1) (ì¶”ì²œ) public keyëŠ” ì›Œì»¤ì—ì„œ ê°€ì ¸ì˜¤ê¸° â€” í”„ë¡ íŠ¸ í•˜ë“œì½”ë”©/ìºì‹œ ë¬¸ì œ ì œê±°
  const { publicKey } = await fetch(
    "https://yongin-tennis-worker.ccoo2000.workers.dev/api/vapid-public",
    { cache: "no-store" }
  ).then(r => r.json());

  const newKey = urlBase64ToUint8Array(publicKey);

  // 2) ê¸°ì¡´ êµ¬ë…ì´ ìˆìœ¼ë©´ ì¬ì‚¬ìš© / í‚¤ ë‹¤ë¥´ë©´ unsubscribe í›„ ì¬êµ¬ë…
  let sub = await reg.pushManager.getSubscription();

  if (sub) {
    const oldKey = sub.options?.applicationServerKey; // ArrayBuffer
    const same =
      oldKey &&
      oldKey.byteLength === newKey.byteLength &&
      new Uint8Array(oldKey).every((v, i) => v === new Uint8Array(newKey)[i]);

    if (!same) {
      await sub.unsubscribe();
      sub = null;
    }
  }

  if (!sub) {
    sub = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: newKey
    });
  }

  // 3) ì„œë²„ ë“±ë¡
  const res = await fetch(
    "https://yongin-tennis-worker.ccoo2000.workers.dev/api/push/subscribe",
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(sub)
    }
  );

  if (!res.ok) {
    const text = await res.text().catch(() => "");
    throw new Error(`subscribe API failed: ${res.status} ${text}`);
  }

  const data = await res.json();
  if (data?.subscription_id) {
    localStorage.setItem("subscription_id", data.subscription_id);
  }
  return data.subscription_id;
}



function getCourtGroup(title){
  return title
    .replace(/\[.*?\]/g, "")   // [ìœ ë£Œ] ì œê±°
    .split("í…Œë‹ˆìŠ¤ì¥")[0]      // 'í…Œë‹ˆìŠ¤ì¥' ì•ê¹Œì§€ë§Œ ì‚¬ìš©
    .trim();
}

function getWeekday(yyyymmdd){
  const d=new Date(
    yyyymmdd.slice(0,4),
    yyyymmdd.slice(4,6)-1,
    yyyymmdd.slice(6,8)
  );
  return ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][d.getDay()];
}

let retryTimer = null;
let retryCount = 0;

async function loadData() {
  try {
    const res = await fetch("https://yongin-tennis-worker.ccoo2000.workers.dev/api/data?_=" + Date.now(), {
      cache: "no-store",
    });

    const data = await res.json();
    DATA = data;

    renderUpdatedTime(data.updated_at);
    buildCourtGroups();
    renderCourts();

  } catch (e) {
    console.error("[loadData error]", e);
    document.getElementById("courts").innerHTML =
      "â³ ì„œë²„ì—ì„œ ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>ì ì‹œ í›„ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.";
  }
}

let pullStartY = null;
let isRefreshing = false;

const pullIndicator = document.getElementById("pullIndicator");
const PULL_THRESHOLD = 70; // ë‹¹ê²¨ì•¼ ìƒˆë¡œê³ ì¹¨ë˜ëŠ” ê±°ë¦¬(px)

window.addEventListener("touchstart", e => {
  if (window.scrollY === 0 && !isRefreshing) {
    pullStartY = e.touches[0].clientY;
  }
}, { passive: true });

window.addEventListener("touchmove", e => {
  if (pullStartY === null || isRefreshing) return;

  const currentY = e.touches[0].clientY;
  const diff = currentY - pullStartY;

  if (diff > 0) {
    e.preventDefault(); // ê¸°ë³¸ ìŠ¤í¬ë¡¤ ë°©ì§€ (ì¤‘ìš”)

    const offset = Math.min(diff, 80);
    pullIndicator.style.top = (-50 + offset) + "px";

    if (diff > PULL_THRESHOLD) {
      pullIndicator.textContent = "ğŸ”„ Refresh";
    } else {
      pullIndicator.textContent = "ğŸ”„ Refresh";
    }
  }
}, { passive: false });

window.addEventListener("touchend", async () => {
  if (pullStartY === null || isRefreshing) return;

  const indicatorTop = parseInt(pullIndicator.style.top || "-50", 10);

  pullIndicator.style.top = "-50px";

  if (indicatorTop > 20) {
    // ğŸ”¥ ìƒˆë¡œê³ ì¹¨ íŠ¸ë¦¬ê±°
    isRefreshing = true;
    pullIndicator.textContent = "â³ Refreshing...";
    pullIndicator.style.top = "0px";

    try {
      await loadData();
      await loadMyAlarms();

    } catch (e) {
      alert("ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: " + e.message);
    }

    pullIndicator.style.top = "-50px";
    isRefreshing = false;
  }

  pullStartY = null;
});



function renderUpdatedTime(isoUtc) {
  if (!isoUtc) return;

  const d = new Date(isoUtc);

  // ğŸ”¥ ë¬´ì‹í•˜ê²Œ 9ì‹œê°„ ì¶”ê°€
  const kstMs = d.getTime() + 9 * 60 * 60 * 1000;
  const kst = new Date(kstMs);

  const hh = String(kst.getHours()).padStart(2, "0");
  const mm = String(kst.getMinutes()).padStart(2, "0");

  document.getElementById("updatedAt").textContent =
    `ì—…ë°ì´íŠ¸: ${hh}:${mm}`;
}



function buildCourtGroups(){
  COURT_GROUPS = {};

  // ğŸ”’ ë°©ì–´ ì½”ë“œ (í•„ìˆ˜)
  if (!DATA || !DATA.facilities || typeof DATA.facilities !== "object") {
    console.warn("DATA.facilities is empty or invalid", DATA);
    return;
  }

  Object.values(DATA.facilities).forEach(f => {
    if (!f || !f.title) return; // 2ì°¨ ë°©ì–´
    const g = getCourtGroup(f.title);
    COURT_GROUPS[g] = true;
  });

  filterCourt.innerHTML = '<option value="">ì½”íŠ¸ ì „ì²´</option>';
  alarmCourt.innerHTML = '<option value="">ì½”íŠ¸ ì„ íƒ</option>';

  Object.keys(COURT_GROUPS)
    .sort((a, b) => a.localeCompare(b, "ko"))
    .forEach(g => {
      filterCourt.innerHTML += `<option>${g}</option>`;
      alarmCourt.innerHTML += `<option>${g}</option>`;
    });
}


filterDate.onchange=()=>{
  filterDateLabel.textContent = filterDate.value;
  renderCourts();
};
alarmDate.onchange=()=>{
  alarmDateLabel.textContent = alarmDate.value;
};

function makeReserveLink(resveId){
  const base =
    "https://publicsports.yongin.go.kr/publicsports/sports/selectFcltyRceptResveViewU.do";
  return `${base}?key=4236&resveId=${resveId}&pageUnit=8&pageIndex=1&checkSearchMonthNow=false`;
}



function renderCourts() {
  const courtsEl = document.getElementById("courts");

  // ğŸ”’ 1ì°¨ ë°©ì–´: DATA êµ¬ì¡° ìì²´ê°€ ì¤€ë¹„ ì•ˆ ëœ ê²½ìš°
  if (
    !DATA ||
    typeof DATA !== "object" ||
    !DATA.facilities ||
    !DATA.availability
  ) {
    courtsEl.textContent = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦";
    return;
  }

  courtsEl.innerHTML = "";

  const gu = filterGu.value;
  const group = filterCourt.value;
  const date = filterDate.value
    ? filterDate.value.replaceAll("-", "")
    : "";

  let renderedCount = 0;

  // ğŸ” ì‹œì„¤ ë‹¨ìœ„ ìˆœíšŒ
  for (const cid in DATA.facilities) {
    const fac = DATA.facilities[cid];
    if (!fac || !fac.title) continue;

    const courtGroup = getCourtGroup(fac.title);

    // ğŸ” í•„í„° ì¡°ê±´
    if (gu && !fac.location?.includes(gu)) continue;
    if (group && courtGroup !== group) continue;

    const days = DATA.availability[cid];
    if (!days || typeof days !== "object") continue;

    let hasAnySlot = false;
    let html = `
      <div class="court-card">
        <div class="court-title">${fac.title}</div>
        <div class="court-loc">${fac.location || ""}</div>
    `;

    // ğŸ“… ë‚ ì§œë³„ ìŠ¬ë¡¯
    for (const d in days) {
      if (date && d !== date) continue;
      const slots = days[d];
      if (!Array.isArray(slots) || slots.length === 0) continue;

      hasAnySlot = true;

      html += `
        <div class="date-box-view">
          <div class="date-title">
            ${d.slice(4, 6)}.${d.slice(6, 8)} (${getWeekday(d)})
          </div>
          <div class="slots">
      `;

      for (const s of slots) {
        if (!s || !s.timeContent) continue;

        const reserveId = s.resveId || cid;

        html += `
          <a
            class="slot"
            href="${makeReserveLink(reserveId)}"
            target="_blank"
            rel="noopener noreferrer"
          >
            ${s.timeContent}
          </a>
        `;
      }

      html += `
          </div>
        </div>
      `;
    }

    html += `</div>`;

    if (hasAnySlot) {
      courtsEl.insertAdjacentHTML("beforeend", html);
      renderedCount++;
    }
  }

  // ğŸ“­ ê²°ê³¼ ì—†ìŒ
  if (renderedCount === 0) {
    courtsEl.textContent = "ì¡°ê±´ì— ë§ëŠ” ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.";
  }
}


async function loadMyAlarms() {
  let subscriptionId = localStorage.getItem("subscription_id");
  const alarmListEl = document.getElementById("alarmList");

  if (!subscriptionId) {
  try {
    subscriptionId = await enablePushIfNeeded({ silent: true });
  } catch {
    alarmListEl.innerHTML = "<li>ì•ŒëŒì´ ì—†ìŠµë‹ˆë‹¤.</li>";
    return;
  }
}

  const res = await fetch(
    API_BASE + "/api/alarm/list?subscription_id=" + encodeURIComponent(subscriptionId)
  );

  if (!res.ok) {
    alarmListEl.innerHTML = "<li>ì•ŒëŒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>";
    return;
  }

  const alarms = await res.json();

  if (alarms.length === 0) {
    alarmListEl.innerHTML = "<li>ë“±ë¡ëœ ì•ŒëŒì´ ì—†ìŠµë‹ˆë‹¤.</li>";
    return;
  }

  alarmListEl.innerHTML = "";

  for (const a of alarms) {
    const li = document.createElement("li");
    li.style.display = "flex";
    li.style.justifyContent = "space-between";
    li.style.alignItems = "center";

    const text = document.createElement("span");
    text.textContent = `${a.date} Â· ${a.court_group}`;

    const delBtn = document.createElement("button");
    delBtn.textContent = "âœ•";
    delBtn.style.fontSize = "12px";
    delBtn.style.padding = "2px 6px";
    delBtn.style.border = "1px solid #ccc";
    delBtn.style.borderRadius = "4px";
    delBtn.style.background = "#fff";
    delBtn.style.color = "#888";


    delBtn.onclick = async () => {
      if (!confirm("ì´ ì•ŒëŒì„ ì‚­ì œí• ê¹Œìš”?")) return;

      await deleteAlarm(a.date, a.court_group);
      await loadMyAlarms(); // âœ… ì¦‰ì‹œ ê°±ì‹ 
    };

    li.appendChild(text);
    li.appendChild(delBtn);
    alarmListEl.appendChild(li);
  }
}

async function deleteAlarm(date, courtGroup) {
  const subscriptionId = localStorage.getItem("subscription_id");

  if (!subscriptionId) {
    alert("subscription_idê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const res = await fetch(API_BASE + "/api/alarm/delete", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      subscription_id: subscriptionId,
      date: date,
      court_group: courtGroup
    })
  });

  if (!res.ok) {
    alert("ì•ŒëŒ ì‚­ì œ ì‹¤íŒ¨");
  }
}
function getExistingSubscriptionId(step) {
  const existing = localStorage.getItem("subscription_id");
  return existing;
}
function checkPushSupport(step) {

  if (!("serviceWorker" in navigator)) {
    throw new Error("serviceWorker not supported");
  }
  if (!("PushManager" in window)) {
    throw new Error("PushManager not supported");
  }

}
async function requestNotificationPermission(step) {

  const permission = await Notification.requestPermission();


  if (permission !== "granted") {
    throw new Error("notification permission denied");
  }

  return permission;
}
async function waitForServiceWorker(step) {

  // 1ï¸âƒ£ ready + timeout ê²½ìŸ
  const readyPromise = navigator.serviceWorker.ready;

  const timeoutPromise = new Promise((_, reject) =>
    setTimeout(() => reject(new Error("serviceWorker.ready timeout")), 3000)
  );

  let reg;
  try {
    reg = await Promise.race([readyPromise, timeoutPromise]);
    return reg;
  } catch (e) {
  }

  // 2ï¸âƒ£ fallback: ê¸°ì¡´ registration ì§ì ‘ ì¡°íšŒ
  const fallbackReg = await navigator.serviceWorker.getRegistration();
  if (!fallbackReg) {
    throw new Error("No service worker registration");
  }

  return fallbackReg;
}

async function subscribePush(reg, step) {

  const sub = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
  });


  return sub;
}
async function sendSubscriptionToServer(sub, step) {

  const res = await fetch(
    "https://yongin-tennis-worker.ccoo2000.workers.dev/api/push/subscribe",
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(sub)
    }
  );


  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error("push/subscribe failed: " + res.status + " " + txt);
  }


  const data = await res.json();


  if (!data.subscription_id) {
    throw new Error("server did not return subscription_id");
  }

  return data.subscription_id;
}

async function enablePushIfNeeded({ silent = false } = {}) {
  function step(msg) {
    alert(msg);
    console.log(msg);
}


  try {

    // 1ï¸âƒ£ ê¸°ì¡´ subscription_id
    const existing = getExistingSubscriptionId(step);
    if (existing) return existing;

    // 2ï¸âƒ£ ì§€ì› ì—¬ë¶€
    checkPushSupport(step);

    // 3ï¸âƒ£ ê¶Œí•œ ìš”ì²­
    const permission = await requestNotificationPermission(step);

    // 4ï¸âƒ£ Service Worker ì¤€ë¹„
    const reg = await waitForServiceWorker(step);

    // 5ï¸âƒ£ Push êµ¬ë…
    const sub = await subscribePush(reg, step);

    // 6ï¸âƒ£ ì„œë²„ ì „ì†¡
    const subscriptionId = await sendSubscriptionToServer(sub, step);

    localStorage.setItem("subscription_id", subscriptionId);

    if (!silent) {
      step("ğŸ‰ PUSH ì´ˆê¸°í™” ìµœì¢… ì™„ë£Œ");
    }
    return subscriptionId;

  } catch (e) {
    console.error("enablePushIfNeeded error:", e);
    if (!silent) {
      alert("âŒ ERROR ë°œìƒ: " + e.message);
    }
    throw e;
  }
}



alarmBtn.onclick = async () => {
  try {
    // ğŸ”¥ 1ï¸âƒ£ push êµ¬ë… í™•ë³´ (ì´ë¯¸ ìˆìœ¼ë©´ ì¬ì‚¬ìš©)
    const subscriptionId = await window.enablePushIfNeeded();

    // 2ï¸âƒ£ ì…ë ¥ê°’ ê²€ì¦
    if (!alarmCourt.value || !alarmDate.value) {
      alert("ì½”íŠ¸ì™€ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”");
      return;
    }

    // ğŸ”¥ 3ï¸âƒ£ ì•ŒëŒ ë“±ë¡
    const res = await fetch(API_BASE + "/api/alarm/add", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        subscription_id: subscriptionId,
        court_group: alarmCourt.value,
        date: alarmDate.value
      })
    });

    // ğŸ”¥ ì„œë²„ê°€ JSONì´ ì•„ë‹ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ë³´í˜¸
    let data = {};
    try {
      data = await res.json();
    } catch {
      throw new Error("ì„œë²„ ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜");
    }

    if (data.status === "duplicate") {
      alert("ì´ë¯¸ ë“±ë¡ëœ ì•ŒëŒì…ë‹ˆë‹¤.");
      return;
    }

    if (data.status === "added") {
      alert("ì•ŒëŒ ë“±ë¡ ì™„ë£Œ!");
    } else {
      alert("ì•ŒëŒ ë“±ë¡ ì‹¤íŒ¨");
    }

  } catch (e) {
    console.error(e);
    alert("ì•Œë¦¼ì„¤ì •/ì•ŒëŒë“±ë¡ ì‹¤íŒ¨: " + e.message);
  }

  // 6ï¸âƒ£ ëª©ë¡ ê°±ì‹ 
  loadMyAlarms();
};


function isDesktop() {
  return window.innerWidth >= 768;
}


if (isDesktop()) {
  flatpickr("#filterDate", {
    dateFormat: "Y-m-d",
    onChange: function(selectedDates, dateStr) {
      filterDateLabel.textContent = dateStr;
      renderCourts();
    }
  });

  flatpickr("#alarmDate", {
    dateFormat: "Y-m-d",
    onChange: function(selectedDates, dateStr) {
      alarmDateLabel.textContent = dateStr;
    }
  });
}

async function init() {

  // â­ ë°ì´í„°ëŠ” ë¬´ì¡°ê±´ ë¨¼ì €
  await loadData();

  // ğŸ”” ì•ŒëŒì€ ê·¸ ë‹¤ìŒ (ë°ì´í„°ë‘ ë…ë¦½)
  await loadMyAlarms();
}



filterGu.onchange=renderCourts;
filterCourt.onchange=renderCourts;

document.addEventListener("DOMContentLoaded", () => {

  // 1ï¸âƒ£ Service Worker ë¨¼ì € ë“±ë¡
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/sw.js")
      .then(reg => {
        console.log("SW registered:", reg.scope);
      })
      .catch(err => {
        console.error("SW register failed:", err);
      });
  }

  // 2ï¸âƒ£ ê·¸ ë‹¤ìŒì— ê¸°ì¡´ ì´ˆê¸°í™” ë¡œì§
  init();
});

document.getElementById("noticeBtn").onclick = () => {
  document.getElementById("noticeModal").style.display = "block";
};

document.getElementById("closeNoticeBtn").onclick = () => {
  document.getElementById("noticeModal").style.display = "none";
};

document.getElementById("noticeModal").onclick = (e) => {
  if (e.target.id === "noticeModal") {
    e.target.style.display = "none";
  }
};


</script>
</body>
</html>
